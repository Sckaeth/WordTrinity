<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<!-- Typography -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Macondo&family=Pragati+Narrow&display=swap" rel="stylesheet">
	<!-- Stylesheets -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
	<link rel="stylesheet" href="{{url_for('static', filename='styles.css')}}">
	<title>Word Trinity</title>
</head>
<body class="container-fluid">
	<!-- Overlay -->
	<div class="body__overlay overlay centered">
		<div class="spinner-border hide" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
		<noscript>
			<p>This website needs JavaScript to run!</p>
		</noscript>
	</div>
	<div class="d-flex flex-column h-100 w-100">
		<!-- Header -->
		<header class="header row pt-4 gx-0 justify-content-center">
			<h1 class="header__title col-12 col-md-auto order-md-1">Word Trinity</h1>
			<div class="header__column col-auto col-md text-md-start order-md-0">
				<button class="header__button" data-bs-toggle="modal" data-bs-target="#info-modal" data-bs-show="#help"><span class="icon material-icons-outlined">help</span></button>
			</div>
			<div class="header__column col-auto col-md text-md-end order-md-2">
				<button class="header__button" data-bs-toggle="modal" data-bs-target="#info-modal" data-bs-show="#stats"><span class="icon material-icons-outlined">equalizer</span></button>
				<button class="header__button" data-bs-toggle="modal" data-bs-target="#info-modal" data-bs-show="#account"><span class="icon material-icons-outlined">settings</span></button>
			</div>
		</header>
		<!-- Main content -->
		<main class="flex-grow-1 d-flex flex-column justify-content-center">
			<!-- Puzzle -->
			<div class="puzzle container">
				<div class="puzzle__overlay overlay hide">
					<div class="centered">
						<div class="spinner-border" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
					</div>
				</div>
				<div class="puzzle__alert">
					<div class="toast align-items-center top-0 start-50 translate-middle-x invert" role="alert" aria-live="assertive" aria-atomic="true" id="puzzle-toast">
						<div class="d-flex">
							<div class="toast-body">Some content here</div>
							<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
						</div>
					</div>
				</div>
				<div class="puzzle__counter">Turns remaining:</div>
				<div class="puzzle__display centered">
					<div class="puzzle__words centered">
						<div class="word centered" id="word-1"></div>
						<div class="word centered" id="word-2"></div>
						<div class="word centered" id="word-3"></div>
					</div>
				</div>
				<div class="puzzle__navigate">
					<button class="" id="shift-left">
						<span class="icon material-icons-outlined lg">rotate_left</span>
						<span class="icon material-icons-outlined sm">arrow_upward</span>
					</button>
					<button class="" id="shift-right">
						<span class="icon material-icons-outlined lg">rotate_right</span>
						<span class="icon material-icons-outlined sm">arrow_downward</span>
					</button>
				</div>
				<div class="puzzle__buttons">
					<button class="text-button" id="submit-word" data-bs-text="Verify word">Verify word</button>
					<button class="text-button" id="submit-puzzle" data-bs-text="Submit all">Submit all</button>
					<button class="text-button" id="reset-letters">Reset letters</button>
					<button class="text-button hide" id="view-results" data-bs-toggle="modal" data-bs-target="#results-modal">View results</button>
				</div>
				<div class="puzzle__letters centered"></div>
			</div>
		</main>
		<!-- Footer -->
		<footer class="centered">Word Trinity</footer>
	</div>
	<!-- Info Modal -->
	<div class="modal fade" id="info-modal" tabindex="-1" aria-labelledby="info-modal" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header modal-header-bg">
					<div class="modal-title h5"></div>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="modal-section" id="help">
						<h4 class="title">How to play</h4>
						<div>
							Solve the daily trinity of words by using the available letters.
							You only have ten tries. Can you beat the average?
						</div>
						<div>
							To win the game you must correctly guess and submit all three words. The puzzle is replaced with a new puzzle at midnight each day.
						</div>
						<div>
							Press the <span class="material-icons-outlined lg">rotate_left</span><span class="material-icons-outlined sm">arrow_upward</span> and <span class="material-icons-outlined lg">rotate_right</span><span class="material-icons-outlined sm">arrow_downward</span> buttons or  <strong>SPACE</strong> key to navigate between words.
						</div>
						<div>
							Click on the word slots or press the <span class="material-icons-outlined">arrow_back</span> and <span class="material-icons-outlined">arrow_forward</span> keys to navigate between slots in the selected word.
						</div>
						<div>
							You can click on the letter slots below the puzzle or use your keyboard to fill up each word slot. The first and last letter of each word is shared with the adjacent words.
						</div>
						<div>
							Press the <span class="text-button">Verify word</span> button or the <strong>ENTER</strong> key to submit a guess, the game will automatically end after all turns are used (or submit all is pressed).
						</div>
						<div>
							Press the <span class="text-button">Submit all</span> button to submit all three words at once
						</div>
						<div><strong>Be careful!</strong> Although this only uses one turn, it immediately finishes the game.</div>
						<div>If you successfully submit a word, the slots of that word will change colour depending on how close you were to the correct answer.</div>
						<div>
							<ul>
								<li>A <span class="state-4 text-dark">green</span> slot means that the letter is correct!</li>
								<li>A <span class="state-3 text-dark">yellow</span> slot means that the letter is in the correct word.</li>
								<li>A <span class="state-2 text-dark">orange</span> slot means that the letter is in the correct position, but in a different word.</li>
								<li>A <span class="state-1 text-dark">red</span> slot means that the letter is not in the correct word or position.</li>
							</ul>
						</div>
						<div>Don't worry if you forget what words you've tried - Word Trinity will remember for you and fill the colours in automatically.</div>
						<div>
							Want to save your progress across devices? Click the <span class="material-icons-outlined">settings</span> button to view your user ID. All you need to do is copy and paste the ID into your new device, and press the <span class="text-button">Change User</span> button. Easy!
						</div>
						<div><em>Note: remember to write down your user ID before clearing your browser cookies!</em></div>
					</div>
					<div class="modal-section container" id="stats">
						<h4 class="title">Statistics</h4>
						<div>Average win rate: <span class="user-winrate statistic"></span>%</div>
						<div>Population win rate: <span class="population-winrate statistic"></span>%</div>
						<div>Population average guesses: <span class="population-guesses statistic"></span></div>
						<div>______</div>
						<div class="graph-title">User guesses</div>
						<div class="graph container">
						</div>
					</div>
					<div class="modal-section" id="account">
						<h4 class="title">User account</h4>
						<div class="account__alert invert"></div>
						<div class="account__userid">USER: <span>{{ session['userid'] }}</span></div>
						<div class="account__change">
							<input type="text" id="new-userid" name="new-userid">
							<button class="text-button" id="change-user">Change User</button>
						</div>
						<div><em>Note: remember to write down your user ID before clearing your browser cookies!</em></div>
					</div>
				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
	<!-- Results Modal -->
	<div class="modal fade" id="results-modal" tabindex="-1" aria-labelledby="results-modal" aria-hidden="true" data-bs-backdrop="false">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header invert">
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="results modal-body invert">
					<div class="results__title h4"></div>
					<div class="results__stats container">
						<div>Guesses used: <span class="user-guesses statistic"></span></div>
						<div>Puzzle win rate: <span class="puzzle-winrate statistic"></span>%</div>
						<div>Average guesses used by other users: <span class="puzzle-guesses statistic"></span></div>
						<div>______</div>
						<div class="graph-title">User guesses</div>
						<div class="graph container">
						</div>
					</div>
				</div>
				<div class="modal-footer invert">
					<!-- Twitter -->
					<a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="" data-hashtags="WordTrinity" data-show-count="false">Tweet</a>
					<!-- Generic share button -->
					<button id="share-results"><span class="icon material-icons-outlined invert">share</span></button>
				</div>
			</div>
		</div>
	</div>
	<!-- Scripts -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
	<script src="{{url_for('static', filename='js/puzzle.js')}}"></script>
	<script src="{{url_for('static', filename='js/modal.js')}}"></script>
	<script>
			$(document).ready(function () { $(".spinner-border").show() });
			$(window).on("load", function () {
				// URLS and user id
				url_load = "{{ url_for('api.load_game') }}";
				url_check = "{{ url_for('api.check_guess') }}";
				url_stats = "{{ url_for('api.get_game_statistics') }}";
				url_user = "{{ url_for('api.change_userid') }}";
                user_id = "{{ session['userid'] }}";

				// Create user and puzzle instance
				let puzzle = new Puzzle();
				puzzle.initPuzzle();
				puzzle.resizePuzzle();

				// Puzzle event listeners; remain bound regardless of puzzle state
				$(window).resize(() => { puzzle.resizePuzzle(); });
                $(document).keyup((event) => { puzzle.onKeyUp(event) });
				$("button").click(() => { document.activeElement.blur() });
				$("#shift-left").click(() => { puzzle.shiftActiveWord(false) });
				$("#shift-right").click(() => { puzzle.shiftActiveWord(true) });

				// Change user and reconstruct puzzle
				$("#change-user").click(() => {
					// Check whether user id is valid
					let text = $("#new-userid");
					let id = text.val();
					let response = $.ajax({
						method: "PUT",
						url: "{{ url_for('api.change_userid') }}",
						async: false,
						data: JSON.stringify(id),
						dataType: "json",
						contentType: "application/json"
					});
					// Server response succeeded
					response.done((data) => {
						if (data.success) {
							user_id = id;
							puzzle.reconstructPuzzle();
							$(".account__userid > span").text(id);
							info_modal.find(".btn-close").trigger("click");
						} else { displayAlert("User ID does not exist") };
					});
					// Server response failed
					response.fail(() => {  displayAccountAlert("Something went wrong...") });
					response.always(() => { text.val("") });
				});
			});
	</script>
</body>
</html>
